<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Synq Chat Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        margin-bottom: 5px;
      }

      /* Connection Form */
      .connection-form {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #f9f9f9;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.3s;
        margin-right: 10px;
      }

      button:hover {
        background: #5568d3;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      button.danger {
        background: #dc3545;
      }

      button.danger:hover {
        background: #c82333;
      }

      /* Status Bar */
      .status-bar {
        padding: 12px 20px;
        text-align: center;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-bar.connected {
        background: #d4edda;
        color: #155724;
      }

      .status-bar.disconnected {
        background: #f8d7da;
        color: #721c24;
      }

      .online-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .online-indicator.online {
        background: #28a745;
      }

      .online-indicator.offline {
        background: #6c757d;
      }

      /* Chat Area */
      .chat-container {
        display: flex;
        height: 500px;
      }

      .sidebar {
        width: 250px;
        border-right: 1px solid #e0e0e0;
        background: #fafafa;
        overflow-y: auto;
      }

      .sidebar-header {
        padding: 15px;
        background: #667eea;
        color: white;
        font-weight: 600;
      }

      .user-list-item {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background 0.2s;
      }

      .user-list-item:hover {
        background: #f0f0f0;
      }

      .user-list-item.active {
        background: #e8eaf6;
        border-left: 3px solid #667eea;
      }

      .user-info {
        flex: 1;
      }

      .user-name {
        font-weight: 600;
        margin-bottom: 3px;
      }

      .user-status {
        font-size: 11px;
        color: #666;
      }

      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        background: white;
        font-weight: 600;
        display: flex;
        align-items: center;
      }

      .chat-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #fafafa;
      }

      .chat-area.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
      }

      .message {
        margin-bottom: 15px;
        padding: 12px;
        border-radius: 8px;
        max-width: 70%;
        word-wrap: break-word;
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.sent {
        background: #667eea;
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.received {
        background: white;
        border: 1px solid #e0e0e0;
      }

      .message-sender {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 12px;
        opacity: 0.8;
      }

      .message.sent .message-sender {
        color: rgba(255, 255, 255, 0.9);
      }

      .message-text {
        margin-bottom: 5px;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.7;
      }

      .typing-indicator {
        padding: 10px 20px;
        font-style: italic;
        color: #666;
        font-size: 13px;
        min-height: 35px;
      }

      /* Input Area */
      .input-area {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        background: white;
      }

      .input-area input {
        flex: 1;
      }

      /* Logs */
      .logs-container {
        margin-top: 20px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      }

      .logs {
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .log-entry {
        padding: 5px;
        margin-bottom: 5px;
        border-left: 3px solid #667eea;
        padding-left: 10px;
      }

      .log-entry.success {
        border-left-color: #28a745;
      }

      .log-entry.error {
        border-left-color: #dc3545;
      }

      .log-entry.info {
        border-left-color: #17a2b8;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸ”¥ Synq Chat Test Client</h1>
        <p>Real-time messaging with presence tracking</p>
      </div>

      <!-- Connection Form -->
      <div class="connection-form" id="connectionForm">
        <div class="form-group">
          <label>Select User to Login:</label>
          <select id="userSelect">
            <option value="">-- Select User --</option>
            <option value="69312d3c841f0018479557a1">Alice</option>
            <option value="69312d68841f0018479557a3">Bob</option>
          </select>
        </div>

        <div class="form-group">
          <label>Room ID (optional, for direct join):</label>
          <input
            type="text"
            id="roomIdInput"
            placeholder="e.g., room:alice_bob or room:group_..."
          />
        </div>

        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()" class="danger">Disconnect</button>
      </div>

      <!-- Status Bar -->
      <div class="status-bar disconnected" id="statusBar">
        <span id="statusText">Disconnected</span>
        <span id="currentUserInfo"></span>
      </div>

      <!-- Chat Container -->
      <div class="chat-container">
        <!-- Sidebar: Users List -->
        <div class="sidebar" id="sidebar" style="display: none">
          <div class="sidebar-header">Online Users</div>
          <div id="usersList">
            <!-- Users will be populated here -->
          </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
          <div class="chat-header" id="chatHeader">
            <span id="chatHeaderText">Select a user to start chatting</span>
          </div>

          <div class="chat-area empty" id="chatArea">
            <p>Connect and select a user to start chatting</p>
          </div>

          <div class="typing-indicator" id="typingIndicator"></div>

          <div class="input-area">
            <input
              type="text"
              id="messageInput"
              placeholder="Type a message..."
              disabled
              onkeypress="handleKeyPress(event)"
            />
            <button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs Container -->
    <div class="container logs-container">
      <div class="header" style="padding: 15px">
        <h3>ðŸ“‹ Event Logs</h3>
      </div>
      <div class="logs" id="logs"></div>
    </div>

    <!-- Socket.io Client Library -->
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <script>
      // Global state
      let socket = null;
      let currentUserId = null;
      let currentUsername = null;
      let currentRoomId = null;
      let onlineUsers = new Map();
      let messageStatusMap = new Map(); // Track message statuses by messageId

      // User ID to username mapping
      const userMap = {
        "69312d3c841f0018479557a1": "alice",
        "69312d68841f0018479557a3": "bob",
      };

      const allUsers = [
        { id: "69312d3c841f0018479557a1", username: "alice" },
        { id: "69312d68841f0018479557a3", username: "bob" },
      ];

      // ================== Logging ==================
      function log(message, type = "info") {
        const logsDiv = document.getElementById("logs");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        logsDiv.appendChild(logEntry);
        logsDiv.scrollTop = logsDiv.scrollHeight;
        console.log(`[${type.toUpperCase()}]`, message);
      }

      // ================== Status Bar ==================
      function updateStatusBar(text, isConnected) {
        const statusBar = document.getElementById("statusBar");
        const statusText = document.getElementById("statusText");
        statusText.textContent = text;
        statusBar.className = `status-bar ${
          isConnected ? "connected" : "disconnected"
        }`;

        if (isConnected && currentUsername) {
          document.getElementById(
            "currentUserInfo"
          ).textContent = `Logged in as: ${currentUsername}`;
        } else {
          document.getElementById("currentUserInfo").textContent = "";
        }
      }

      // ================== Connection ==================
      function connect() {
        const userId = document.getElementById("userSelect").value;

        if (!userId) {
          alert("Please select a user");
          return;
        }

        currentUserId = userId;
        currentUsername = userMap[userId];

        log(`ðŸ”Œ Connecting as ${currentUsername}...`);

        socket = io("http://localhost:3000", {
          query: { userId: currentUserId },
          transports: ["websocket", "polling"],
        });

        setupSocketListeners();
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
          log("ðŸ‘‹ Manually disconnected", "info");
          resetUI();
        }
      }

      function resetUI() {
        updateStatusBar("Disconnected", false);
        document.getElementById("sidebar").style.display = "none";
        document.getElementById("chatArea").innerHTML =
          "<p>Connect and select a user to start chatting</p>";
        document.getElementById("chatArea").classList.add("empty");
        document.getElementById("messageInput").disabled = true;
        document.getElementById("sendBtn").disabled = true;
        currentRoomId = null;
        messageStatusMap.clear();
      }

      // ================== Socket Event Listeners ==================
      function setupSocketListeners() {
        socket.on("connect", () => {
          log(`âœ… Connected! Socket ID: ${socket.id}`, "success");
          updateStatusBar("Connected", true);
          document.getElementById("sidebar").style.display = "block";

          renderUsersList();

          const roomId = document.getElementById("roomIdInput").value.trim();
          if (roomId) {
            joinRoom(roomId);
          }
        });

        socket.on("online_users_list", (data) => {
          log(`ðŸ“‹ Received ${data.users.length} online users`, "success");

          data.users.forEach((user) => {
            if (user._id !== currentUserId) {
              onlineUsers.set(user._id, {
                username: user.username,
                isOnline: user.isOnline,
                lastSeen: user.lastSeen,
              });
            }
          });

          renderUsersList();
        });

        socket.on("disconnect", () => {
          log("âŒ Disconnected from server", "error");
          resetUI();
        });

        socket.on("user_online", (data) => {
          const username = userMap[data.userId] || data.userId;
          log(`ðŸŸ¢ ${username} came online`, "success");
          onlineUsers.set(data.userId, { username, isOnline: true });
          renderUsersList();
        });

        socket.on("user_offline", (data) => {
          const username = userMap[data.userId] || data.userId;
          const lastSeen = new Date(data.lastSeen).toLocaleTimeString();
          log(`ðŸ”´ ${username} went offline (last seen: ${lastSeen})`, "info");
          onlineUsers.set(data.userId, {
            username,
            isOnline: false,
            lastSeen: data.lastSeen,
          });
          renderUsersList();
        });

        socket.on("joined_room", (data) => {
          console.log("ðŸŽ‰ Handler started", data);
          log(`âœ… Joined room: ${data.roomId}`, "success");

          console.log("ðŸŽ‰ Setting currentRoomId");
          currentRoomId = data.roomId;

          console.log("ðŸŽ‰ Clearing chat area");
          document.getElementById("chatArea").innerHTML = "";
          document.getElementById("chatArea").classList.remove("empty");

          console.log("ðŸŽ‰ Enabling inputs...");
          document.getElementById("messageInput").disabled = false;
          document.getElementById("sendBtn").disabled = false;
          console.log("ðŸŽ‰ Inputs enabled!");

          updateChatHeader();
          markRoomAsRead();
        });

        // âœ… NEW: Receive message + auto-emit delivery receipt
        socket.on("receive_message", (data) => {
          log(`ðŸ“© Message from ${data.senderId.username}: "${data.text}"`);

          // Store initial status
          messageStatusMap.set(data._id, data.status || "Sent");

          // Display the message
          displayMessage(data);

          // âœ… AUTO-EMIT: Message delivered (if not sent by me)
          if (data.senderId._id !== currentUserId) {
            socket.emit("message_delivered", {
              messageId: data._id,
              roomId: data.roomId,
            });
            log(`âœ“ Delivery receipt sent for message ${data._id}`, "success");

            // âœ… If chat is currently open, also mark as read
            if (currentRoomId === data.roomId) {
              setTimeout(() => {
                socket.emit("message_read", {
                  messageId: data._id,
                  roomId: data.roomId,
                });
                log(`âœ“âœ“ Read receipt sent for message ${data._id}`, "success");
              }, 500); // Small delay to simulate reading
            }
          }
        });

        // âœ… NEW: Handle status updates from server
        socket.on("message_status_update", (data) => {
          const { messageId, messageIds, status } = data;
          const ids = messageIds || [messageId];

          ids.forEach((id) => {
            messageStatusMap.set(id, status);
            updateMessageStatus(id, status);
          });

          log(
            `âœ“ Status updated to "${status}" for ${ids.length} message(s)`,
            "success"
          );
        });

        // âœ… NEW: Unread count reset confirmation
        socket.on("unread_reset", (data) => {
          log(`âœ… Unread count reset for room ${data.roomId}`, "success");
        });

        socket.on("user_typing", (data) => {
          const username = userMap[data.userId] || "Someone";
          const indicator = document.getElementById("typingIndicator");
          if (data.isTyping && data.userId !== currentUserId) {
            indicator.textContent = `${username} is typing...`;
          } else {
            indicator.textContent = "";
          }
        });

        socket.on("error", (data) => {
          log(`âŒ Error: ${data.message}`, "error");
          alert(`Error: ${data.message}`);
        });
      }

      // âœ… NEW: Mark entire room as read when opening chat
      function markRoomAsRead() {
        if (!socket || !currentRoomId || !currentUserId) return;

        socket.emit("mark_room_read", {
          roomId: currentRoomId,
          userId: currentUserId,
        });

        log(`âœ“ Marking all messages in ${currentRoomId} as read`, "info");
      }

      // âœ… NEW: Update message status indicator in UI
      function updateMessageStatus(messageId, status) {
        const messageElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (!messageElement) return;

        const statusIndicator = messageElement.querySelector(".message-status");
        if (statusIndicator) {
          statusIndicator.textContent = getStatusIcon(status);
          statusIndicator.title = status;
        }
      }

      // âœ… NEW: Get status icon based on message status
      function getStatusIcon(status) {
        switch (status) {
          case "Sent":
            return "âœ“";
          case "Delivered":
            return "âœ“âœ“";
          case "Read":
            return "âœ“âœ“"; // You can style this blue in CSS
          default:
            return "";
        }
      }

      // ================== Users List ==================
      function renderUsersList() {
        const usersList = document.getElementById("usersList");
        usersList.innerHTML = "";

        allUsers.forEach((user) => {
          if (user.id === currentUserId) return;

          const userInfo = onlineUsers.get(user.id) || { isOnline: false };
          const item = document.createElement("div");
          item.className = "user-list-item";
          item.onclick = () => openChatWithUser(user.id, user.username);

          const indicator = userInfo.isOnline
            ? '<span class="online-indicator online"></span>'
            : '<span class="online-indicator offline"></span>';

          const status = userInfo.isOnline
            ? "Online"
            : userInfo.lastSeen
            ? `Last seen ${new Date(userInfo.lastSeen).toLocaleTimeString()}`
            : "Offline";

          item.innerHTML = `
          ${indicator}
          <div class="user-info">
            <div class="user-name">${user.username}</div>
            <div class="user-status">${status}</div>
          </div>
        `;

          usersList.appendChild(item);
        });
      }

      function openChatWithUser(userId, username) {
        const roomId = `room:${[currentUsername, username].sort().join("_")}`;

        // âœ… Prevent duplicate joins
        if (currentRoomId === roomId) {
          log(`Already in room ${roomId}`, "info");
          return;
        }

        log(`ðŸ“‚ Opening chat with ${username} in room: ${roomId}`);
        joinRoom(roomId);
      }

      // ================== Room ==================
      function joinRoom(roomId) {
        if (!socket || !currentUserId) {
          alert("Not connected");
          return;
        }

        log(`ðŸšª Joining room: ${roomId}...`);
        socket.emit("join_room", {
          roomId: roomId,
          userId: currentUserId,
        });
      }

      function updateChatHeader() {
        const headerText = document.getElementById("chatHeaderText");
        if (currentRoomId) {
          headerText.textContent = `ðŸ’¬ ${currentRoomId}`;
        } else {
          headerText.textContent = "Select a user to start chatting";
        }
      }

      // ================== Messaging ==================
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const text = input.value.trim();

        if (!text) return;
        if (!socket || !currentUserId || !currentRoomId) {
          alert("Not connected to a room");
          return;
        }

        log(`ðŸ“¤ Sending: "${text}"`);

        socket.emit("send_message", {
          roomId: currentRoomId,
          userId: currentUserId,
          text: text,
        });

        input.value = "";
      }

      // âœ… UPDATED: Display message with status indicator
      function displayMessage(data) {
        const chatArea = document.getElementById("chatArea");
        const messageDiv = document.createElement("div");

        const isSent = data.senderId._id === currentUserId;
        messageDiv.className = `message ${isSent ? "sent" : "received"}`;
        messageDiv.setAttribute("data-message-id", data._id); // âœ… Track message ID

        const senderDiv = document.createElement("div");
        senderDiv.className = "message-sender";
        senderDiv.textContent = data.senderId.username;

        const textDiv = document.createElement("div");
        textDiv.className = "message-text";
        textDiv.textContent = data.text;

        const timeDiv = document.createElement("div");
        timeDiv.className = "message-time";
        const time = new Date(data.createdAt).toLocaleTimeString();

        // âœ… Add status indicator for sent messages
        const status = messageStatusMap.get(data._id) || data.status || "Sent";
        const statusIcon = isSent
          ? ` <span class="message-status" title="${status}">${getStatusIcon(
              status
            )}</span>`
          : "";

        timeDiv.innerHTML = `${time}${statusIcon}`;

        messageDiv.appendChild(senderDiv);
        messageDiv.appendChild(textDiv);
        messageDiv.appendChild(timeDiv);

        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      // ================== Typing Indicator ==================
      let typingTimeout; // âœ… Add semicolon here!

      document.getElementById("messageInput").addEventListener("input", (e) => {
        if (!socket || !currentRoomId || !currentUserId) return;

        socket.emit("typing", {
          roomId: currentRoomId,
          userId: currentUserId,
          isTyping: true,
        });

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("typing", {
            roomId: currentRoomId,
            userId: currentUserId,
            isTyping: false,
          });
        }, 1000);
      });
    </script>
  </body>
</html>
